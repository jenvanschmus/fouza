---
import BaseLayout from '../layouts/BaseLayout.astro';

const allItems = await Astro.glob('../content/gallery/*.md');

// Sort by date (newest first)
const sortedItems = allItems.sort((a, b) => {
  return new Date(b.frontmatter.date).getTime() - new Date(a.frontmatter.date).getTime();
});

const categories = ["Bracelets", "Necklaces", "Rings", "Earrings", "Pendants", "Brooches", "Artwork"];
---

<BaseLayout title="Gallery Archive">
  <div class="gallery-page">
    
    <header class="gallery-header">
      <div class="meta-tag">ARCHIVE // INDEX</div>
      <h1 class="univern-font">Collection</h1>
      
      <div class="filter-controls">
        {categories.map(cat => (
          <label class="filter-chip">
            <input type="checkbox" name="category" value={cat.toLowerCase()} class="cat-checkbox" />
            <span class="chip-label">{cat}</span>
          </label>
        ))}
      </div>

      <div class="search-section">
        <input 
          type="text" 
          id="gallery-search" 
          placeholder="Search by keyword..." 
          autocomplete="off"
        />
        <div class="search-line"></div>
      </div>
    </header>

    <section class="gallery-grid" id="main-grid">
      {sortedItems.map((item) => (
        <div 
          class="gallery-card" 
          data-category={item.frontmatter.category?.toLowerCase() || ""}
          data-search={`${item.frontmatter.title} ${item.rawContent()}`.toLowerCase()}
        >
          <div class="image-frame">
            <img src={item.frontmatter.image} alt={item.frontmatter.title} loading="lazy" />
          </div>
          
          <div class="item-content">
            <div class="item-header">
              <span class="ref-code">REF // {item.file.split('/').pop().replace('.md', '').toUpperCase()}</span>
              <h3 class="item-title">{item.frontmatter.title}</h3>
            </div>
            
            <div class="item-description">
              <item.Content />
            </div>
          </div>
        </div>
      ))}
    </section>

    <div id="no-results" class="empty-state" style="display: none;">
      <p>No matching pieces found in the archive.</p>
    </div>

  </div>
</BaseLayout>

<script>
  const searchInput = document.getElementById('gallery-search') as HTMLInputElement;
  const checkboxes = document.querySelectorAll('.cat-checkbox');
  const cards = document.querySelectorAll('.gallery-card');
  const noResults = document.getElementById('no-results');

  // Handle filtering
  function applyFilters() {
    const searchTerm = searchInput.value.toLowerCase();
    const activeCategories = Array.from(checkboxes)
      .filter(i => (i as HTMLInputElement).checked)
      .map(i => (i as HTMLInputElement).value);

    let matchCount = 0;

    cards.forEach(card => {
      const cardContent = card.getAttribute('data-search') || "";
      const cardCategory = card.getAttribute('data-category') || "";
      
      const matchesSearch = cardContent.includes(searchTerm);
      const matchesCategory = activeCategories.length === 0 || activeCategories.includes(cardCategory);

      if (matchesSearch && matchesCategory) {
        (card as HTMLElement).style.display = 'block';
        matchCount++;
      } else {
        (card as HTMLElement).style.display = 'none';
      }
    });

    if (noResults) {
      noResults.style.display = matchCount === 0 ? 'block' : 'none';
    }
  }

  // Listeners
  searchInput?.addEventListener('input', applyFilters);
  checkboxes.forEach(box => box.addEventListener('change', applyFilters));

  // Fix: Clear placeholder on focus
  searchInput?.addEventListener('focus', () => {
    searchInput.setAttribute('data-placeholder', searchInput.placeholder);
    searchInput.placeholder = '';
  });
  searchInput?.addEventListener('blur', () => {
    searchInput.placeholder = searchInput.getAttribute('data-placeholder') || 'Search by keyword...';
  });
</script>

<style>
  .gallery-page { max-width: 1400px; margin: 0 auto; padding: 100px 40px; }
  .gallery-header { text-align: center; margin-bottom: 80px; }
  .univern-font { font-size: 3.5rem; letter-spacing: 0.15em; text-transform: uppercase; margin-bottom: 40px; }
  .meta-tag { font-family: 'Special Elite', monospace !important; font-size: 10px; color: #ccc; letter-spacing: 0.5em; margin-bottom: 20px; }

  /* Checkbox Chips */
  .filter-controls {
    display: flex;
    flex-wrap: wrap;
    justify-content: center;
    gap: 15px;
    margin-bottom: 40px;
  }
  .filter-chip { cursor: pointer; }
  .cat-checkbox { display: none; }
  .chip-label {
    display: inline-block;
    padding: 8px 18px;
    border: 1px solid #eee;
    font-size: 0.75rem;
    text-transform: uppercase;
    letter-spacing: 0.1em;
    color: #999;
    transition: all 0.2s ease;
  }
  .cat-checkbox:checked + .chip-label {
    background: #000;
    color: #fff;
    border-color: #000;
  }

  /* Search */
  .search-section { max-width: 400px; margin: 0 auto; position: relative; }
  #gallery-search {
    width: 100%; border: none; background: transparent; padding: 15px;
    text-align: center; font-size: 0.9rem; letter-spacing: 0.1em; outline: none;
    text-transform: uppercase;
  }
  .search-line { height: 1px; background: #eee; width: 100%; }

  /* Grid */
  .gallery-grid {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(380px, 1fr));
    gap: 80px 40px;
  }
  .image-frame { aspect-ratio: 1/1; background: #fcfcfc; border: 1px solid #f2f2f2; overflow: hidden; margin-bottom: 25px; }
  .image-frame img { width: 100%; height: 100%; object-fit: cover; }
  .ref-code { font-family: 'Special Elite', monospace !important; font-size: 10px; color: #ddd; }
  .item-title { font-size: 1.6rem; text-transform: uppercase; margin: 8px 0 15px 0; }
  .item-description { font-family: sans-serif !important; font-size: 0.95rem; color: #666; line-height: 1.7; }

  .empty-state { text-align: center; padding: 100px 0; color: #ccc; text-transform: uppercase; letter-spacing: 0.2em; }

  @media (max-width: 768px) {
    .gallery-grid { grid-template-columns: 1fr; }
    .univern-font { font-size: 2.2rem; }
  }
</style>

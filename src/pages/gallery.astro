---
import BaseLayout from '../layouts/BaseLayout.astro';
import { getCollection } from 'astro:content';

// 1. ATTEMPT TO FETCH THE COLLECTION
let rawItems = [];
let error: string | null = null;

try {
  rawItems = await getCollection('gallery');
} catch (e) {
  error = e instanceof Error ? e.message : 'Unknown error fetching collection';
}

// 2. LOGIC CHECK
const hasItems = rawItems && rawItems.length > 0;

// 3. RENDER CONTENT
const galleryItems = hasItems ? await Promise.all(
  rawItems.map(async (item) => {
    try {
      const { Content } = await item.render();
      return { ...item, Content, renderError: null };
    } catch (e) {
      return { ...item, Content: null, renderError: 'Failed to render markdown' };
    }
  })
) : [];
---

<BaseLayout title="Gallery Debug Mode">
  <div class="gallery-wrapper">
    
    {(!hasItems || error) && (
      <div class="debug-panel">
        <h2 class="debug-title">üõ†Ô∏è System Diagnostic</h2>
        <div class="debug-grid">
          <div class="debug-stat">
            <span class="label">Status:</span>
            <span class={`value ${error ? 'err' : 'ok'}`}>{error ? 'Failed' : 'Connected'}</span>
          </div>
          <div class="debug-stat">
            <span class="label">Items Found:</span>
            <span class="value">{rawItems.length}</span>
          </div>
          <div class="debug-stat">
            <span class="label">Target Path:</span>
            <span class="value">src/content/gallery/</span>
          </div>
        </div>
        {error && <p class="error-msg"><strong>Error Details:</strong> {error}</p>}
        <div class="troubleshooting">
          <p><strong>Common Fixes:</strong></p>
          <ul>
            <li>Check if <code>src/content/gallery/</code> exists and contains <code>.md</code> files.</li>
            <li>Ensure <code>src/content/config.ts</code> exports <code>collections = &#123; 'gallery': gallery &#125;</code>.</li>
            <li>Restart your development server (<code>npm run dev</code>).</li>
          </ul>
        </div>
      </div>
    )}

    <header class="gallery-header">
      <span class="technical-meta">FOUZA // ARCHIVE INDEX</span>
      <h1 class="univern-text">Collection</h1>
      
      <div class="search-container">
        <input 
          type="text" 
          id="gallery-search" 
          placeholder="SEARCH ARCHIVE..." 
          autocomplete="off"
        />
        <div class="line-accent"></div>
      </div>
    </header>

    {hasItems && (
      <div class="gallery-grid" id="main-grid">
        {galleryItems.map((item) => (
          <div class="gallery-card" data-search={`${item.data.title} ${item.body}`.toLowerCase()}>
            <div class="image-frame">
              {item.data.image ? (
                <img src={item.data.image} alt={item.data.title} loading="lazy" />
              ) : (
                <div class="missing-img">Missing Image Path</div>
              )}
            </div>
            
            <div class="card-details">
              <span class="ref-code">REF // {item.slug.toUpperCase()}</span>
              <h3 class="item-title">{item.data.title}</h3>
              
              <div class="item-body">
                {item.Content ? <item.Content /> : <p class="err">{item.renderError}</p>}
              </div>
            </div>
          </div>
        ))}
      </div>
    )}

    <div id="no-results" class="hidden-state">
      <p>No matching artifacts found.</p>
    </div>
  </div>
</BaseLayout>

<script>
  const searchInput = document.getElementById('gallery-search') as HTMLInputElement;
  const cards = document.querySelectorAll('.gallery-card');
  const noResults = document.getElementById('no-results');

  searchInput?.addEventListener('input', (e) => {
    const term = (e.target as HTMLInputElement).value.toLowerCase();
    let visibleCount = 0;

    cards.forEach(card => {
      const searchContent = card.getAttribute('data-search') || "";
      if (searchContent.includes(term)) {
        (card as HTMLElement).style.display = 'block';
        visibleCount++;
      } else {
        (card as HTMLElement).style.display = 'none';
      }
    });

    if (noResults) {
      noResults.style.display = visibleCount === 0 ? 'block' : 'none';
    }
  });
</script>

<style>
  /* --- STYLING --- */
  .gallery-wrapper { max-width: 1400px; margin: 0 auto; padding: 100px 40px; }
  .gallery-header { text-align: center; margin-bottom: 80px; }
  .univern-text { font-size: 4rem; letter-spacing: 0.15em; text-transform: uppercase; }
  .technical-meta { font-family: 'Special Elite', monospace !important; font-size: 10px; color: #ccc; letter-spacing: 0.4em; }

  #gallery-search {
    width: 100%; max-width: 500px; border: none; padding: 20px; 
    background: transparent; text-align: center; font-size: 1.1rem; outline: none;
  }
  .line-accent { height: 1px; background: #eee; width: 100%; max-width: 500px; margin: 0 auto; }

  /* Grid Logic */
  .gallery-grid {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(380px, 1fr));
    gap: 80px 40px;
  }

  .image-frame {
    aspect-ratio: 1/1; background: #f9f9f9; border: 1px solid #f2f2f2;
    overflow: hidden; margin-bottom: 25px; display: flex; align-items: center; justify-content: center;
  }
  .image-frame img { width: 100%; height: 100%; object-fit: cover; }
  .missing-img { font-family: monospace; color: #f56565; font-size: 0.8rem; }

  .ref-code { font-family: 'Special Elite', monospace !important; font-size: 10px; color: #ddd; }
  .item-title { font-size: 1.8rem; margin: 10px 0; text-transform: uppercase; letter-spacing: 0.05em; }
  .item-body { font-family: sans-serif !important; font-size: 1rem; color: #555; line-height: 1.7; }

  /* Debug Panel Styles */
  .debug-panel {
    background: #fffafa; border: 1px solid #ffebeb; padding: 40px; margin-bottom: 60px;
    border-radius: 4px; font-family: monospace;
  }
  .debug-title { color: #e53e3e; margin-bottom: 20px; text-transform: uppercase; font-size: 1.2rem; }
  .debug-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 20px; margin-bottom: 20px; }
  .debug-stat { display: flex; flex-direction: column; }
  .label { color: #999; font-size: 0.7rem; text-transform: uppercase; }
  .value { font-weight: bold; font-size: 1rem; }
  .value.ok { color: #38a169; }
  .value.err { color: #e53e3e; }
  .error-msg { background: #fee2e2; padding: 15px; border-radius: 4px; color: #9b2c2c; margin-top: 20px; }
  .troubleshooting { margin-top: 20px; font-size: 0.9rem; color: #4a5568; line-height: 1.6; }
  .hidden-state { display: none; text-align: center; padding: 100px; color: #ccc; text-transform: uppercase; }
</style>

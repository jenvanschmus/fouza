---
import BaseLayout from '../layouts/BaseLayout.astro';

const itemFiles = import.meta.glob('../content/gallery/*.md', { eager: true });
const allItems = Object.values(itemFiles) as any[];

const sortedItems = allItems.sort((a, b) => {
  const titleA = a.frontmatter.title || "";
  const titleB = b.frontmatter.title || "";
  return titleA.localeCompare(titleB);
});

const categories = ["Bracelets", "Necklaces", "Rings", "Earrings", "Pendants", "Brooches", "Artwork", "Other"];
---

<BaseLayout title="Gallery">
  <div class="gallery-page-wrapper">
    <div class="technical-grid"></div>

    <div class="gallery-content-container">
      <header class="gallery-header">
        <p class="blueprint-label">Phase // 02 â€” Exhibition</p>
        <h1 class="univern-font">Gallery</h1>
        
        <div class="filter-wrapper">
          <div class="filter-controls">
            {categories.map(cat => (
              <label class="filter-chip">
                <input type="checkbox" name="category" value={cat.toLowerCase()} class="cat-checkbox" />
                <span class="chip-label">{cat}</span>
              </label>
            ))}
          </div>
          
          <div class="clear-action-area">
            <button id="clear-filters" class="clear-btn" style="display: none;">Clear All</button>
          </div>
        </div>

        <div class="search-section">
          <input type="text" id="gallery-search" placeholder="Search by keyword..." autocomplete="off" />
          <div class="search-line"></div>
        </div>
      </header>

      <section class="gallery-grid" id="main-grid">
        {sortedItems.map((item) => (
          <div 
            class="gallery-card expand-trigger" 
            data-category={Array.isArray(item.frontmatter.category) ? item.frontmatter.category.map(c => c.toLowerCase()).join(' ') : item.frontmatter.category?.toLowerCase() || ""}
            data-search={`${item.frontmatter.title} ${item.rawContent ? item.rawContent() : ''}`.toLowerCase()}
          >
            <div class="image-frame">
              <img src={item.frontmatter.image} alt={item.frontmatter.title} loading="lazy" />
            </div>
            
            <div class="item-content">
              <h3 class="item-title">{item.frontmatter.title}</h3>
              <div class="item-description main-view-desc">
                <item.Content />
              </div>
            </div>
          </div>
        ))}
      </section>

      <div id="no-results" class="empty-state" style="display: none;">
        <p>No matching pieces found in the archive.</p>
      </div>
    </div>
  </div>

  <div id="lightbox" class="lightbox">
    <div class="lightbox-modal">
      <div class="lightbox-close-wrapper">
        <span class="lightbox-close">&times;</span>
      </div>
      
      <div class="modal-body">
        <div class="modal-image-container" id="zoom-container">
          <img id="lightbox-img" src="" alt="" />
        </div>
        <div class="modal-text-container">
          <h2 id="lightbox-title" class="univern-font"></h2>
          <div id="lightbox-desc" class="item-description modal-desc"></div>
        </div>
      </div>
    </div>
  </div>
</BaseLayout>

<script>
  const searchInput = document.getElementById('gallery-search') as HTMLInputElement;
  const checkboxes = document.querySelectorAll('.cat-checkbox');
  const cards = document.querySelectorAll('.gallery-card');
  const noResults = document.getElementById('no-results');
  const clearBtn = document.getElementById('clear-filters');
  
  const lightbox = document.getElementById('lightbox');
  const lightboxImg = document.getElementById('lightbox-img') as HTMLImageElement;
  const zoomContainer = document.getElementById('zoom-container');
  const lightboxTitle = document.getElementById('lightbox-title');
  const lightboxDesc = document.getElementById('lightbox-desc');
  const closeBtn = document.querySelector('.lightbox-close');

  let isZoomed = false;
  const zoomScale = 1.875; 

  zoomContainer?.addEventListener('click', () => {
    isZoomed = !isZoomed;
    if (lightboxImg && zoomContainer) {
      if (isZoomed) {
        lightboxImg.style.transform = `scale(${zoomScale})`;
        zoomContainer.style.cursor = 'zoom-out';
      } else {
        lightboxImg.style.transform = 'scale(1)';
        zoomContainer.style.cursor = 'zoom-in';
      }
    }
  });

  zoomContainer?.addEventListener('mousemove', (e: MouseEvent) => {
    const rect = zoomContainer.getBoundingClientRect();
    const x = ((e.clientX - rect.left) / rect.width) * 100;
    const y = ((e.clientY - rect.top) / rect.height) * 100;
    if (lightboxImg) lightboxImg.style.transformOrigin = `${x}% ${y}%`;
  });

  document.querySelectorAll('.expand-trigger').forEach(trigger => {
    trigger.addEventListener('click', () => {
      const img = trigger.querySelector('img');
      const title = trigger.querySelector('.item-title')?.textContent;
      const descHtml = trigger.querySelector('.item-description')?.innerHTML;

      if (lightbox && lightboxImg && lightboxTitle && lightboxDesc && img) {
        lightboxImg.src = img.src;
        lightboxTitle.textContent = title || "";
        lightboxDesc.innerHTML = descHtml || "";
        lightbox.classList.add('active');
        document.body.style.overflow = 'hidden';
        isZoomed = false;
        lightboxImg.style.transform = 'scale(1)';
        if (zoomContainer) zoomContainer.style.cursor = 'zoom-in';
      }
    });
  });

  const closeLightbox = () => {
    lightbox?.classList.remove('active');
    document.body.style.overflow = '';
    isZoomed = false;
    if (lightboxImg) lightboxImg.style.transform = 'scale(1)';
  };

  closeBtn?.addEventListener('click', (e) => {
    e.stopPropagation();
    closeLightbox();
  });
  
  lightbox?.addEventListener('click', (e) => {
    if (e.target === lightbox) closeLightbox();
  });

  function applyFilters() {
    const searchTerm = searchInput.value.toLowerCase();
    const activeFilters = Array.from(checkboxes)
      .filter(i => (i as HTMLInputElement).checked)
      .map(i => (i as HTMLInputElement).value);

    let matchCount = 0;
    cards.forEach(card => {
      const cardContent = card.getAttribute('data-search') || "";
      const cardCategories = (card.getAttribute('data-category') || "").split(' ');
      const matchesSearch = cardContent.includes(searchTerm);
      const matchesCategory = activeFilters.length === 0 || activeFilters.some(filter => cardCategories.includes(filter));

      (card as HTMLElement).style.display = (matchesSearch && matchesCategory) ? 'block' : 'none';
      if (matchesSearch && matchesCategory) matchCount++;
    });

    if (noResults) noResults.style.display = (matchCount === 0) ? 'block' : 'none';
    if (clearBtn) clearBtn.style.display = (activeFilters.length > 0 || searchTerm.length > 0) ? 'inline-block' : 'none';
  }

  searchInput?.addEventListener('input', applyFilters);
  checkboxes.forEach(box => box.addEventListener('change', applyFilters));
  clearBtn?.addEventListener('click', () => {
    searchInput.value = '';
    checkboxes.forEach(box => (box as HTMLInputElement).checked = false);
    applyFilters();
  });
</script>

<style>
  :global(html, body) {
    overflow-x: hidden;
    position: relative;
    width: 100%;
    box-sizing: border-box;
    -webkit-tap-highlight-color: transparent; 
  }

  .gallery-page-wrapper { position: relative; min-height: 100vh; background: #fff; width: 100%; }
  .technical-grid { position: absolute; inset: 0; opacity: 0.04; pointer-events: none; background-image: linear-gradient(#000 1px, transparent 1px), linear-gradient(90deg, #000 1px, transparent 1px); background-size: 40px 40px; }
  .gallery-content-container { position: relative; z-index: 10; max-width: 1400px; margin: 0 auto; padding: 60px 20px; width: 100%; box-sizing: border-box; }
  
  .univern-font { 
    font-size: clamp(2rem, 8vw, 3.5rem); 
    letter-spacing: 0.15em; 
    text-transform: uppercase; 
    margin-bottom: 30px; 
    color: #111; 
    word-break: normal; 
    overflow-wrap: break-word; 
  }

  .blueprint-label { font-family: 'Special Elite', monospace !important; font-size: 10px; text-transform: uppercase; letter-spacing: 0.5em; color: #999; margin-bottom: 20px; text-align: center; }
  .gallery-header { text-align: center; margin-bottom: 60px; }

  /* --- Improved Filter Layout --- */
  .filter-wrapper {
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 20px;
    margin-bottom: 40px;
  }

  .filter-controls { 
    display: flex; 
    flex-wrap: wrap; 
    justify-content: center; 
    gap: 10px; 
  }

  .cat-checkbox { display: none; }

  .chip-label, .clear-btn { 
    display: inline-block; 
    padding: 8px 18px; 
    border: 1px solid #ccc; 
    font-size: 0.7rem; 
    text-transform: uppercase; 
    letter-spacing: 0.12em; 
    color: #444; 
    background: #fff; 
    cursor: pointer; 
    transition: all 0.2s ease; 
    font-family: inherit;
    -webkit-tap-highlight-color: transparent;
  }

  .clear-action-area {
    min-height: 35px; /* Keeps layout stable when button appears/disappears */
    display: flex;
    justify-content: center;
  }

  .clear-btn { 
    border-color: #111; 
    color: #111; 
    font-weight: bold; 
  }
  .clear-btn:hover { background: #f0f0f0; transform: translateY(-1px); }

  .cat-checkbox:checked + .chip-label { background: #111; color: #fff; border-color: #111; }
  
  #gallery-search { width: 100%; border: none; background: transparent; padding: 10px; text-align: center; font-size: 0.85rem; text-transform: uppercase; color: #111; outline: none; }
  .search-section { max-width: 300px; margin: 0 auto 40px; }
  .search-line { height: 1px; background: #999; width: 100%; }

  .gallery-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(300px, 1fr)); gap: 80px 40px; }
  .gallery-card { display: flex; flex-direction: column; cursor: pointer; transition: transform 0.3s ease; -webkit-tap-highlight-color: transparent; }
  .image-frame { aspect-ratio: 10 / 11; background: #fcfcfc; border: 1px solid #e0e0e0; overflow: hidden; margin-bottom: 20px; }
  .image-frame img { width: 100%; height: 100%; object-fit: cover; }
  .item-title { font-size: 1.3rem; text-transform: uppercase; margin-bottom: 10px; color: #111; }
  .item-description { font-family: sans-serif !important; font-size: 0.95rem; line-height: 1.6; color: #444; }
  .main-view-desc { display: -webkit-box; -webkit-line-clamp: 3; -webkit-box-orient: vertical; overflow: hidden; }

  .lightbox { display: none; position: fixed; inset: 0; z-index: 10000; background: rgba(0,0,0,0.8); padding: 5vh 5vw; align-items: center; justify-content: center; }
  .lightbox.active { display: flex; }
  .lightbox-modal { background: #fff; width: 100%; max-width: 1200px; height: 85vh; position: relative; border: 1px solid #111; display: flex; box-sizing: border-box; }
  .lightbox-close-wrapper { position: absolute; top: 20px; right: 25px; z-index: 100; }
  .lightbox-close { font-size: 30px; cursor: pointer; color: #111; display: flex; align-items: center; justify-content: center; width: 40px; height: 40px; background: #fff; border: 1px solid #111; transition: all 0.2s ease; }
  .lightbox-close:hover { background: #000; color: #fff; }

  .modal-body { display: flex; width: 100%; height: 100%; overflow: hidden; }
  .modal-image-container { flex: 1.3; background: #f5f5f5; overflow: hidden; display: flex; align-items: center; justify-content: center; border-right: 1px solid #eee; cursor: zoom-in; }
  .modal-image-container img { width: 100%; height: 100%; object-fit: contain; transition: transform 0.3s cubic-bezier(0.165, 0.84, 0.44, 1); }
  
  .modal-text-container { flex: 0.7; padding: 60px 50px; text-align: left; display: flex; flex-direction: column; justify-content: center; background: #fff; overflow-y: auto; }
  
  /* --- WHOLE WORD PROTECTION --- */
  .modal-desc, .modal-text-container h2 { 
    font-size: 1.1rem; 
    line-height: 1.8; 
    color: #222; 
    text-align: left;
    white-space: normal;
    word-break: normal;        
    overflow-wrap: break-word; 
    hyphens: none !important;
    -webkit-hyphens: none !important;
  }

  @media (max-width: 768px) {
    .gallery-content-container { padding: 40px 20px; }
    .gallery-grid { grid-template-columns: repeat(2, 1fr); gap: 30px 15px; }
    .lightbox { padding: 8vh 6vw; }
    .lightbox-modal { height: 75vh; width: 100%; flex-direction: column; overflow: visible; }
    .lightbox-close-wrapper { top: -60px; right: 0; }
    .lightbox-close { box-shadow: 0 4px 15px rgba(0,0,0,0.2); }
    .modal-body { flex-direction: column; overflow-y: auto; }
    .modal-image-container { border-right: none; border-bottom: 1px solid #eee; height: 40vh; flex: none; pointer-events: none; }
    .modal-text-container { padding: 35px 25px; flex: none; height: auto; }
    .modal-text-container h2 { font-size: 1.6rem; margin-bottom: 15px; }
    .modal-desc { font-size: 1rem; line-height: 1.6; }
  }

  @media (max-width: 380px) {
    .gallery-grid { grid-template-columns: 1fr; }
  }
</style>

---
import BaseLayout from '../layouts/BaseLayout.astro';

// Vite-Style File Loading
const itemFiles = import.meta.glob('../content/gallery/*.md', { eager: true });
const allItems = Object.values(itemFiles) as any[];

// Alphabetical Sort
const sortedItems = allItems.sort((a, b) => {
  const titleA = a.frontmatter.title || "";
  const titleB = b.frontmatter.title || "";
  return titleA.localeCompare(titleB);
});

const categories = ["Bracelets", "Necklaces", "Rings", "Earrings", "Pendants", "Brooches", "Artwork", "Other"];
---

<BaseLayout title="Gallery">
  <div class="gallery-page-wrapper">
    <div class="technical-grid"></div>

    <div class="gallery-content-container">
      <header class="gallery-header">
        <p class="blueprint-label">Phase // 02 â€” Exhibition</p>
        <h1 class="univern-font">Gallery</h1>
        
        <div class="filter-wrapper">
          <div class="filter-controls">
            {categories.map(cat => (
              <label class="filter-chip">
                <input type="checkbox" name="category" value={cat.toLowerCase()} class="cat-checkbox" />
                <span class="chip-label">{cat}</span>
              </label>
            ))}
          </div>
          <button id="clear-filters" class="clear-btn" style="display: none;">Clear All</button>
        </div>

        <div class="search-section">
          <input 
            type="text" 
            id="gallery-search" 
            placeholder="Search by keyword..." 
            autocomplete="off"
          />
          <div class="search-line"></div>
        </div>
      </header>

      <section class="gallery-grid" id="main-grid">
        {sortedItems.map((item) => (
          <div 
            class="gallery-card" 
            data-category={Array.isArray(item.frontmatter.category) ? item.frontmatter.category.map(c => c.toLowerCase()).join(' ') : item.frontmatter.category?.toLowerCase() || ""}
            data-search={`${item.frontmatter.title} ${item.rawContent ? item.rawContent() : ''}`.toLowerCase()}
          >
            <div class="image-frame expand-trigger">
              <img src={item.frontmatter.image} alt={item.frontmatter.title} loading="lazy" />
              <div class="expand-overlay"><span>Expand Detail</span></div>
            </div>
            
            <div class="item-content">
              <div class="item-header">
                <h3 class="item-title">{item.frontmatter.title}</h3>
              </div>
              <div class="item-description">
                <item.Content />
              </div>
            </div>
          </div>
        ))}
      </section>

      <div id="no-results" class="empty-state" style="display: none;">
        <p>No matching pieces found in the archive.</p>
      </div>
    </div>
  </div>

  <div id="lightbox" class="lightbox">
    <span class="lightbox-close">&times;</span>
    <img class="lightbox-content" id="lightbox-img" alt="Expanded Archive View" />
    <div id="lightbox-caption"></div>
  </div>
</BaseLayout>

<script>
  const searchInput = document.getElementById('gallery-search') as HTMLInputElement;
  const checkboxes = document.querySelectorAll('.cat-checkbox');
  const cards = document.querySelectorAll('.gallery-card');
  const noResults = document.getElementById('no-results');
  const clearBtn = document.getElementById('clear-filters');
  
  // Lightbox Elements
  const lightbox = document.getElementById('lightbox');
  const lightboxImg = document.getElementById('lightbox-img') as HTMLImageElement;
  const triggers = document.querySelectorAll('.expand-trigger');
  const closeBtn = document.querySelector('.lightbox-close');

  /* --- Lightbox Logic --- */
  triggers.forEach(trigger => {
    trigger.addEventListener('click', () => {
      const img = trigger.querySelector('img');
      if (img && lightbox && lightboxImg) {
        lightboxImg.src = img.src;
        lightbox.classList.add('active');
        document.body.style.overflow = 'hidden'; // Lock scroll
      }
    });
  });

  closeBtn?.addEventListener('click', () => {
    lightbox?.classList.remove('active');
    document.body.style.overflow = ''; // Unlock scroll
  });

  lightbox?.addEventListener('click', (e) => {
    if (e.target === lightbox) {
      lightbox.classList.remove('active');
      document.body.style.overflow = '';
    }
  });

  /* --- Filter/Search Logic --- */
  function applyFilters() {
    const searchTerm = searchInput.value.toLowerCase();
    const activeFilters = Array.from(checkboxes)
      .filter(i => (i as HTMLInputElement).checked)
      .map(i => (i as HTMLInputElement).value);

    if (clearBtn) {
      clearBtn.style.display = (activeFilters.length > 0 || searchTerm.length > 0) ? 'inline-block' : 'none';
    }

    let matchCount = 0;
    cards.forEach(card => {
      const cardContent = card.getAttribute('data-search') || "";
      const cardCategories = (card.getAttribute('data-category') || "").split(' ');
      const matchesSearch = cardContent.includes(searchTerm);
      const matchesCategory = activeFilters.length === 0 || activeFilters.some(filter => cardCategories.includes(filter));

      if (matchesSearch && matchesCategory) {
        (card as HTMLElement).style.display = 'flex'; // Reset to flex for desktop
        matchCount++;
      } else {
        (card as HTMLElement).style.display = 'none';
      }
    });

    if (noResults) noResults.style.display = (matchCount === 0) ? 'block' : 'none';
  }

  searchInput?.addEventListener('input', applyFilters);
  checkboxes.forEach(box => box.addEventListener('change', applyFilters));
  clearBtn?.addEventListener('click', () => {
    searchInput.value = '';
    checkboxes.forEach(box => (box as HTMLInputElement).checked = false);
    applyFilters();
  });
</script>

<style>
  .gallery-page-wrapper {
    position: relative;
    min-height: 100vh;
    background: #fff;
    overflow-x: hidden;
  }

  .technical-grid {
    position: absolute;
    inset: 0;
    opacity: 0.04;
    pointer-events: none;
    background-image: linear-gradient(#000 1px, transparent 1px), linear-gradient(90deg, #000 1px, transparent 1px);
    background-size: 40px 40px;
  }

  .gallery-content-container {
    position: relative;
    z-index: 10;
    max-width: 1200px;
    margin: 0 auto;
    padding: 60px 20px;
  }

  .gallery-header { text-align: center; margin-bottom: 60px; }
  .blueprint-label { font-family: 'Special Elite', monospace !important; font-size: 10px; text-transform: uppercase; letter-spacing: 0.5em; color: #999; margin-bottom: 20px; }
  .univern-font { font-size: 3.5rem; letter-spacing: 0.15em; text-transform: uppercase; margin-bottom: 30px; color: #111; }
  
  .filter-controls { display: flex; flex-wrap: wrap; justify-content: center; gap: 10px; margin-bottom: 20px; }
  .cat-checkbox { position: absolute; opacity: 0; width: 0; height: 0; }
  .chip-label { display: inline-block; padding: 8px 18px; border: 1px solid #ccc; font-size: 0.7rem; text-transform: uppercase; letter-spacing: 0.12em; color: #444; background: #fff; cursor: pointer; transition: 0.2s; }
  .cat-checkbox:checked + .chip-label { background: #111; color: #fff; border-color: #111; }
  
  .search-section { max-width: 300px; margin: 0 auto 40px; }
  #gallery-search { width: 100%; border: none; background: transparent; padding: 10px; text-align: center; font-size: 0.85rem; text-transform: uppercase; color: #111; outline: none; }
  .search-line { height: 1px; background: #999; width: 100%; }

  /* DYNAMIC LAYOUT: List on Desktop, Grid on Mobile */
  .gallery-grid { 
    display: flex;
    flex-direction: column;
    gap: 100px;
  }

  .gallery-card { 
    display: flex;
    gap: 60px;
    align-items: flex-start;
  }

  .image-frame { 
    flex: 1; /* Half width on desktop */
    aspect-ratio: 11 / 10; 
    background: #fcfcfc; 
    border: 1px solid #e0e0e0; 
    overflow: hidden;
    cursor: pointer;
    position: relative;
  }
  .image-frame img { width: 100%; height: 100%; object-fit: cover; transition: transform 0.5s ease; }
  
  /* Hover zoom effect */
  .image-frame:hover img { transform: scale(1.05); }
  .expand-overlay {
    position: absolute;
    inset: 0;
    background: rgba(0,0,0,0.1);
    display: flex;
    align-items: center;
    justify-content: center;
    opacity: 0;
    transition: opacity 0.3s;
  }
  .expand-overlay span {
    background: #fff;
    padding: 10px 20px;
    font-size: 10px;
    text-transform: uppercase;
    letter-spacing: 0.2em;
    color: #111;
  }
  .image-frame:hover .expand-overlay { opacity: 1; }

  .item-content { flex: 1; text-align: left; }
  .item-title { font-size: 2rem; text-transform: uppercase; margin-bottom: 20px; color: #111; }
  .item-description { font-family: sans-serif !important; font-size: 1.05rem; color: #333; line-height: 1.8; }

  /* LIGHTBOX STYLES */
  .lightbox {
    display: none;
    position: fixed;
    z-index: 10000;
    inset: 0;
    background: rgba(255,255,255,0.98);
    padding: 40px;
    align-items: center;
    justify-content: center;
  }
  .lightbox.active { display: flex; }
  .lightbox-content { max-width: 95%; max-height: 90vh; object-fit: contain; box-shadow: 0 30px 60px rgba(0,0,0,0.1); }
  .lightbox-close { position: absolute; top: 30px; right: 40px; font-size: 40px; cursor: pointer; color: #111; }

  /* MOBILE RESPONSIVE: 2-WIDE GRID */
  @media (max-width: 768px) {
    .gallery-content-container { padding: 40px 40px; } /* Wider screen margins */
    
    .gallery-grid { 
      display: grid;
      grid-template-columns: repeat(2, 1fr); /* 2 wide */
      gap: 40px 20px;
    }

    .gallery-card { 
      display: block; /* Stack: Image Top, Text Bottom */
    }

    .image-frame { margin-bottom: 20px; }
    .item-title { font-size: 1.2rem; margin-bottom: 10px; }
    .item-description { font-size: 0.85rem; line-height: 1.5; }
    
    .expand-overlay { display: none; } /* Disable hover text for touch */
  }

  @media (max-width: 480px) {
    .univern-font { font-size: 1.8rem; }
    .gallery-content-container { padding: 40px 30px; }
    .gallery-grid { gap: 40px 15px; }
  }
</style>
